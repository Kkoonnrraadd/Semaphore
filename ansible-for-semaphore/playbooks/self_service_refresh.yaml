---
- name: Self-Service Data Refresh
  hosts: localhost
  environment:
    AZURE_CONFIG_DIR: /home/semaphore/.azure
  vars:
    # === Required Variables ===
    # These must be defined when running the playbook
    
    # === REQUIRED PARAMETERS - No defaults, must be provided ===
    source_environment: "{{ source_env }}"
    source_subscription_id: "{{ source_sub_id }}"
    source_resource_group: "{{ source_rg | default('rg-mnfro-intd-' + source_env + '-weu') }}"
    
    dest_environment: "{{ dest_env }}"
    dest_subscription_id: "{{ dest_sub_id }}"
    dest_resource_group: "{{ dest_rg | default('rg-mnfro-intd-' + dest_env + '-weu') }}"
    dest_cluster_name: "{{ dest_cluster | default('aks-mnfro-intd-' + dest_env + '-weu') }}"
    
    # === REQUIRED NAMESPACE PARAMETERS ===
    # These are set in the role's set_fact task to avoid circular references
    
    # === OPTIONAL PARAMETERS WITH DEFAULTS ===
    # These are now set in the role to avoid circular references
    terraform_env_path: "{{ terraform_path | default('public') }}"
    
    # Hub configuration for monitoring
    hub_resource_group: "{{ hub_rg | default('rg-mnfro-hub-weu') }}"
    hub_subscription_id: "{{ hub_sub_id | default('a9261cc1-d170-491d-b8fa-23ef0ad88ba3') }}"
    
    # === OPERATION CONFIGURATION ===
    dry_run: "{{ dry_run_mode | default(false) | bool }}"
    max_wait_minutes: "{{ max_wait | default(30) | int }}"
    operation: "{{ op | default('full') }}"
    
    # === Step Control Variables ===
    # Set to true to skip specific steps
    skip_restore: "{{ skip_restore_step | default(false) | bool }}"
    skip_stop: "{{ skip_stop_step | default(false) | bool }}"
    skip_copy_attachments: "{{ skip_copy_attachments_step | default(false) | bool }}"
    skip_copy_database: "{{ skip_copy_database_step | default(false) | bool }}"
    skip_adjust_resources: "{{ skip_adjust_resources_step | default(false) | bool }}"
    skip_start: "{{ skip_start_step | default(false) | bool }}"
    skip_cleanup: "{{ skip_cleanup_step | default(false) | bool }}"
    skip_permissions: "{{ skip_permissions_step | default(false) | bool }}"

  pre_tasks:
    - name: Validate required parameters
      ansible.builtin.assert:
        that:
          - source_env is defined
          - dest_env is defined
          - source_sub_id is defined
          - dest_sub_id is defined
          - source_ns is defined
          - dest_ns is defined
          - customer is defined
        fail_msg: |
          ‚ùå Missing required parameters!
          
          Required parameters:
          ‚Ä¢ source_env (source environment name)
          ‚Ä¢ dest_env (destination environment name) 
          ‚Ä¢ source_sub_id (source subscription ID)
          ‚Ä¢ dest_sub_id (destination subscription ID)
          ‚Ä¢ source_ns (source namespace)
          ‚Ä¢ dest_ns (destination namespace)
          ‚Ä¢ customer (customer alias)
          
          Example usage:
          ansible-playbook playbooks/self_service_refresh.yaml \
            --extra-vars "source_env=gov002 dest_env=gov001 \
                         source_sub_id=xxx dest_sub_id=yyy \
                         source_ns=manufacturo dest_ns=test \
                         customer=gov001-test"

    - name: Display playbook information
      ansible.builtin.debug:
        msg: |
          üöÄ Self-Service Data Refresh Playbook
          ====================================
          
          üìä Environment Configuration:
          ‚Ä¢ Source: {{ source_environment }} ({{ source_ns }})
          ‚Ä¢ Destination: {{ dest_environment }} ({{ dest_ns }})
          ‚Ä¢ Cloud: {{ cloud | default('AzureUSGovernment') }}
          ‚Ä¢ Customer: {{ customer }}
          
          ‚öôÔ∏è Operation Settings:
          ‚Ä¢ Operation: {{ operation }}
          ‚Ä¢ Dry Run: {{ dry_run }}
          ‚Ä¢ Max Wait: {{ max_wait_minutes }} minutes
          
          üéØ Step Control:
          ‚Ä¢ Skip Restore: {{ skip_restore }}
          ‚Ä¢ Skip Stop Environment: {{ skip_stop }}
          ‚Ä¢ Skip Copy Attachments: {{ skip_copy_attachments }}
          ‚Ä¢ Skip Copy Database: {{ skip_copy_database }}
          ‚Ä¢ Skip Adjust Resources: {{ skip_adjust_resources }}
          ‚Ä¢ Skip Start Environment: {{ skip_start }}
          ‚Ä¢ Skip Cleanup: {{ skip_cleanup }}
          ‚Ä¢ Skip Permissions: {{ skip_permissions }}

    - name: Confirm operation in production
      ansible.builtin.pause:
        prompt: |
          ‚ö†Ô∏è  WARNING: You are about to perform a data refresh operation!
          
          This will:
          1. Create a restore point from {{ source_environment }}
          2. Stop the {{ dest_environment }} environment
          3. Copy data from {{ source_environment }} to {{ dest_environment }}
          4. Reconfigure and restart {{ dest_environment }}
          
          Type 'yes' to continue, or 'no' to abort
      register: confirm_operation
      when: not dry_run and dest_environment in ['prod', 'production']

    - name: Abort if not confirmed
      ansible.builtin.fail:
        msg: "Operation aborted by user"
      when: 
        - not dry_run 
        - dest_environment in ['prod', 'production']
        - confirm_operation.user_input | lower != 'yes'

  tasks:
    - name: Execute self-service refresh
      ansible.builtin.include_role:
        name: self_service_refresh
      vars:
        # Pass the input variables directly to avoid circular references
        source_env: "{{ source_env }}"
        dest_env: "{{ dest_env }}"
        source_sub_id: "{{ source_sub_id }}"
        dest_sub_id: "{{ dest_sub_id }}"
        source_ns: "{{ source_ns }}"
        dest_ns: "{{ dest_ns }}"
        customer: "{{ customer }}"
        # Cloud variable will be set by role with default
        dry_run_mode: "{{ dry_run }}"
        max_wait: "{{ max_wait_minutes }}"
        op: "{{ operation }}"

  post_tasks:
    - name: Final status report
      ansible.builtin.debug:
        msg: |
          ‚úÖ Self-Service Data Refresh Completed
          ====================================
          
          üìä Summary:
          ‚Ä¢ Source: {{ source_environment }} ‚Üí Destination: {{ dest_environment }}
          ‚Ä¢ Customer: {{ customer_alias }}
          ‚Ä¢ Operation: {{ operation }}
          ‚Ä¢ Dry Run: {{ dry_run }}
          ‚Ä¢ Duration: {{ ansible_date_time.epoch | int - (start_time | default(ansible_date_time.epoch)) | int }} seconds
          
          üéØ Next Steps:
          ‚Ä¢ Verify application functionality
          ‚Ä¢ Check data integrity
          ‚Ä¢ Monitor system performance
          ‚Ä¢ Update documentation if needed
